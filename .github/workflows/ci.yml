name: Raft Implementation CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Build and Unit Tests
  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew build -x test
    
    - name: Run Unit Tests
      run: ./gradlew test --tests "*Test"
      
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: build/test-results/test/
        retention-days: 7
    
    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-reports
        path: build/reports/tests/test/
        retention-days: 7

  # Job 2: Persistence & Database Tests
  persistence-tests:
    name: H2 Database & Persistence Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Run Persistence Tests
      run: ./gradlew test --tests "*Persistence*" --tests "*Database*"
      
    - name: Verify H2 Database Creation
      run: |
        ./gradlew bootRun --args='--spring.profiles.active=node1' &
        APP_PID=$!
        sleep 15
        
        # Check if database files were created
        if [ -f "./data/node1/raft-db.mv.db" ]; then
          echo "✓ H2 database file created successfully"
        else
          echo "✗ H2 database file not found"
          kill $APP_PID
          exit 1
        fi
        
        kill $APP_PID
        sleep 2
        
    - name: Upload Database Files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: h2-database-files
        path: data/node1/
        retention-days: 3

  # Job 3: Integration Tests (Cluster Simulation)
  integration-tests:
    name: Cluster Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build application
      run: ./gradlew build -x test
    
    - name: Start 3-Node Cluster
      run: |
        nohup ./gradlew bootRun --args='--spring.profiles.active=node1' > node1.log 2>&1 &
        echo $! > node1.pid
        sleep 10
        
        nohup ./gradlew bootRun --args='--spring.profiles.active=node2' > node2.log 2>&1 &
        echo $! > node2.pid
        sleep 10
        
        nohup ./gradlew bootRun --args='--spring.profiles.active=node3' > node3.log 2>&1 &
        echo $! > node3.pid
        sleep 15
    
    - name: Test Leader Election
      run: |
        echo "Testing leader election..."
        MAX_RETRIES=20
        RETRY_COUNT=0
        LEADER_FOUND=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          for PORT in 8081 8082 8083; do
            RESPONSE=$(curl -s http://localhost:$PORT/api/raft/health || echo "")
            if echo "$RESPONSE" | grep -q '"state":"LEADER"'; then
              echo "✓ Leader found on port $PORT"
              LEADER_FOUND=true
              break 2
            fi
          done
          RETRY_COUNT=$((RETRY_COUNT + 1))
          sleep 2
        done
        
        if [ "$LEADER_FOUND" = false ]; then
          echo "✗ No leader elected"
          exit 1
        fi
    
    - name: Test Command Replication
      run: |
        echo "Testing command submission and replication..."
        
        # Find leader
        LEADER_PORT=""
        for PORT in 8081 8082 8083; do
          RESPONSE=$(curl -s http://localhost:$PORT/api/raft/health || echo "")
          if echo "$RESPONSE" | grep -q '"state":"LEADER"'; then
            LEADER_PORT=$PORT
            break
          fi
        done
        
        # Submit 5 commands
        for i in {1..5}; do
          curl -s -X POST http://localhost:$LEADER_PORT/api/raft/command \
            -H "Content-Type: application/json" \
            -d "{\"command\": \"test-cmd-$i\"}" > /dev/null
          sleep 1
        done
        
        sleep 5
        
        # Verify replication on all nodes
        for PORT in 8081 8082 8083; do
          RESPONSE=$(curl -s http://localhost:$PORT/api/raft/state-machine)
          ENTRY_COUNT=$(echo "$RESPONSE" | grep -o 'test-cmd' | wc -l)
          
          if [ "$ENTRY_COUNT" -ge 5 ]; then
            echo "✓ Node $PORT: $ENTRY_COUNT commands replicated"
          else
            echo "✗ Node $PORT: only $ENTRY_COUNT commands"
            exit 1
          fi
        done
    
    - name: Test Crash Recovery
      run: |
        echo "Testing crash recovery..."
        
        # Find follower and crash it
        FOLLOWER_PORT=""
        for PORT in 8081 8082 8083; do
          RESPONSE=$(curl -s http://localhost:$PORT/api/raft/health || echo "")
          if echo "$RESPONSE" | grep -q '"state":"FOLLOWER"'; then
            FOLLOWER_PORT=$PORT
            break
          fi
        done
        
        case $FOLLOWER_PORT in
          8081) kill $(cat node1.pid); PROFILE="node1" ;;
          8082) kill $(cat node2.pid); PROFILE="node2" ;;
          8083) kill $(cat node3.pid); PROFILE="node3" ;;
        esac
        
        sleep 3
        
        # Restart node
        nohup ./gradlew bootRun --args="--spring.profiles.active=$PROFILE" > ${PROFILE}-restart.log 2>&1 &
        sleep 15
        
        # Verify recovery
        RESPONSE=$(curl -s http://localhost:$FOLLOWER_PORT/api/raft/health || echo "")
        if echo "$RESPONSE" | grep -q '"state":"FOLLOWER"'; then
          echo "✓ Node recovered successfully"
        else
          echo "✗ Node failed to recover"
          exit 1
        fi
    
    - name: Test Snapshot Creation
      run: |
        echo "Testing snapshot creation..."
        
        # Find leader
        LEADER_PORT=""
        for PORT in 8081 8082 8083; do
          RESPONSE=$(curl -s http://localhost:$PORT/api/raft/health || echo "")
          if echo "$RESPONSE" | grep -q '"state":"LEADER"'; then
            LEADER_PORT=$PORT
            break
          fi
        done
        
        # Submit more commands
        for i in {6..15}; do
          curl -s -X POST http://localhost:$LEADER_PORT/api/raft/command \
            -H "Content-Type: application/json" \
            -d "{\"command\": \"snap-test-$i\"}" > /dev/null
        done
        
        sleep 3
        
        # Create snapshot
        RESPONSE=$(curl -s -X POST http://localhost:$LEADER_PORT/api/raft/snapshot/create)
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "✓ Snapshot created"
        else
          echo "✗ Snapshot creation failed"
          exit 1
        fi
    
    - name: Cleanup
      if: always()
      run: |
        [ -f node1.pid ] && kill $(cat node1.pid) 2>/dev/null || true
        [ -f node2.pid ] && kill $(cat node2.pid) 2>/dev/null || true
        [ -f node3.pid ] && kill $(cat node3.pid) 2>/dev/null || true
        pkill -f 'gradle.*bootRun' || true
    
    - name: Upload Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-logs
        path: "*.log"
        retention-days: 7
